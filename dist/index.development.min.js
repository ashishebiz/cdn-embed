"use strict";var IdentityVerificationCDN=(()=>{var $=Object.defineProperty;var _=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var b=(e,t,n)=>t in e?$(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,L=(e,t)=>{for(var n in t||(t={}))F.call(t,n)&&b(e,n,t[n]);if(_)for(var n of _(t))K.call(t,n)&&b(e,n,t[n]);return e};var g=(e,t,n)=>new Promise((i,o)=>{var a=l=>{try{d(n.next(l))}catch(y){o(y)}},r=l=>{try{d(n.throw(l))}catch(y){o(y)}},d=l=>l.done?i(l.value):Promise.resolve(l.value).then(a,r);d((n=n.apply(e,t)).next())});var S="https://develop-api.chainit.online",C="/rule-engine/v1/age-app-embed/generate-qr",P="/rule-engine/v1/age-app-embed/get-qr",M="/public-base/v1/embed/validate",x="x-sign-key",N="x-organization-id",q={"Content-Type":"application/json"},U={AGE_APP:"age_app",CHECK_IN:"check_in"},A="#embed-qr-code",H="#embed-qr-code-logs",D=5e3,u=1e4,s={WaitingForScan:"WaitingForScan",Timeout:"Timeout",Scanned:"Scanned",Approved:"Approved",RejectedByUser:"RejectedByUser",RejectedByRequirement:"RejectedByRequirement",SomethingWentWrong:"SomethingWentWrong"},h="Location permission denied. Please enable it manually in browser settings.",v="Geolocation is not supported by this browser";var w=e=>({Timeout:`
    <div style="margin-bottom: 10px; color: #fff;">QR expired.</div>
    <a id='new-qr-button' style="
      margin-top: 10px;
      display: inline-block;
      padding: 10px 20px;
      background-color: #000;
      border: 1px solid #fff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      cursor:pointer;
    ">New QR</a>
  `,Scanned:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u23F3</div>
    <div style="color: #fff;">Scanning in progress...</div>
  `,Approved:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u2705</div>
    <div style="color: #00ff99;">Access granted in 10s.</div>
  `,RejectedByUser:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u274C</div>
    <div style="color: #ff4444;">Access Denied</div>
  `,RejectedByRequirement:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u274C</div>
    <div style="color: #ff4444;">Access Denied</div>
  `,WaitingForScan:"",SomethingWentWrong:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u26A0\uFE0F</div>
    <div style="color: #ff4444;">Something went wrong</div>
  `})[e],O=e=>({Timeout:"QR Expired",Scanned:"Scanning in progress",Approved:"Access Granted",RejectedByUser:"Access Denied",RejectedByRequirement:"Access Denied",WaitingForScan:"Waiting for scan",SomethingWentWrong:"Something went wrong"})[e],m=(e="Something went wrong")=>`<div style="background:#111;color:#fff;padding:10px 14px;border-radius:6px;font-size:14px;">${e}</div>`;function G(e){return`
    <div id="qr-code" class="w-100 h-100" style="cursor:pointer;text-align:center;">
      <img src="${e}" alt="QR Code" style="width:100%;height:100%;" />
    </div>
    `}function k(e){return`
    <div style="
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      flex-direction: column;">
      ${w(e)}
    </div>
  `}var E=e=>document.querySelector(e);function Q(e,t){if(!e)return;let n=document.createElement("p");n.innerHTML=O(t),n.style.cssText="margin-bottom:10px;padding:8px;",e.prepend(n)}var f=(e,t)=>setTimeout(()=>window.location.href=e,t);var R=(...e)=>console.log("[cdn-embed]",...e),p=(...e)=>console.error("[cdn-embed]",...e);var V=e=>{let t=e*1e3;return new Promise(n=>setTimeout(n,t))},W=()=>{let e=document.currentScript;return{apiKey:(e==null?void 0:e.dataset.apiKey)||"",successRedirectURL:(e==null?void 0:e.dataset.successUrl)||"",failRedirectURL:(e==null?void 0:e.dataset.failureUrl)||"",notificationURL:(e==null?void 0:e.dataset.notificationUrl)||""}},j=e=>g(null,null,function*(){if((yield Y())==="denied")throw e&&(e.innerHTML=m(h)),alert(h),new Error(h);return new Promise((n,i)=>{"geolocation"in navigator?navigator.geolocation.getCurrentPosition(o=>{var d,l;let a=(d=o.coords.latitude)!=null?d:0,r=(l=o.coords.longitude)!=null?l:0;n({latitude:a,longitude:r})},o=>{e&&(e.innerHTML=m(h)),i(`ERR_LOC : Error getting location: ${o.message}`)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):(e&&(e.innerHTML=m(v)),i(v))})}),Y=()=>g(null,null,function*(){if(!navigator.permissions)return"prompt";try{return(yield navigator.permissions.query({name:"geolocation"})).state}catch(e){return"prompt"}});function I(n){return g(this,arguments,function*(e,t={}){var o;let i=yield fetch(e,{method:"GET",headers:t});if(!i.ok){let a=(o=yield i.json())==null?void 0:o.message;throw alert("Something Went Wrong"),new Error(`${i.status} : ${a}`)}return i.json()})}function B(i,o){return g(this,arguments,function*(e,t,n={}){var r;let a=yield fetch(e,{method:"POST",headers:L(L({},q),n),body:JSON.stringify(t)});if(!a.ok){let d=(r=yield a.json())==null?void 0:r.message;throw alert("Something Went Wrong"),new Error(`${a.status} : ${d}`)}return a.json()})}var T=class{constructor(t){this.pollingId=null;this.qrContainer=null;this.location=null;this.apiKey="";this.apiKey=t}configure(t){this.options=t}clearPolling(){this.pollingId!==null&&(clearInterval(this.pollingId),this.pollingId=null)}displayQRCode(t,n){var i;if(this.qrContainer=E(this.options.qrContainerSelector),!this.qrContainer){p("QR Container not found"),this.clearPolling();return}this.qrContainer.innerHTML=G(t),(i=document.getElementById("qr-code"))==null||i.addEventListener("click",()=>window.open(n,"_blank"))}startPolling(t){if(this.clearPolling(),!t)throw new Error("Session ID not found");this.pollingId=window.setInterval(()=>g(this,null,function*(){try{let n=`${S}${P}/${t}`,i=yield I(n,{[x]:this.apiKey});Q(E(this.options.logContainerSelector||""),i.scanningState),i!=null&&i.scanningState&&(yield this.handleState(i.scanningState))}catch(n){this.qrContainer&&(this.qrContainer.innerHTML=m()),p("Polling error",n),yield this.handleState(s.Timeout),this.clearPolling()}}),D)}handleState(t){return g(this,null,function*(){var i;let n=this.options;if(!n.qrContainerSelector){p("QR Container selector not provided"),this.clearPolling();return}switch(this.qrContainer&&t!==s.WaitingForScan&&(this.qrContainer.innerHTML=k(t)),t){case s.WaitingForScan:return;case s.Scanned:R(t);break;case s.Approved:this.clearPolling(),n.successRedirectURL&&f(n.successRedirectURL,u);break;case s.Timeout:R(n),this.clearPolling(),(i=document.getElementById("new-qr-button"))==null||i.addEventListener("click",()=>this.validateIdentityAndGenerateQRCode());break;case s.SomethingWentWrong:this.clearPolling(),n.failRedirectURL&&f(n.failRedirectURL,u);break;case s.RejectedByUser:case s.RejectedByRequirement:this.clearPolling(),yield V(10),yield this.validateIdentityAndGenerateQRCode();break;default:p("Invalid state:",t),this.clearPolling();break}})}validateIdentityAndGenerateQRCode(){return g(this,null,function*(){try{this.qrContainer=E(this.options.qrContainerSelector),this.location=yield j(this.qrContainer);let t=`${S}${M}`,n=yield B(t,{token:this.apiKey,successNavigateUrl:this.options.successRedirectURL,failureNavigateUrl:this.options.failRedirectURL,notificationUrl:this.options.notificationURL});if(!n.status||!n.data)throw new Error("Invalid identity");let{contextType:i,entityId:o,orgId:a}=n.data;switch(i){case U.AGE_APP:yield this.generateAgeAppQRCode(o,a);break;default:p("Unknown context type");break}return}catch(t){this.qrContainer&&(this.qrContainer.innerHTML=m()),p("Failed to generate QR code:",t)}})}generateAgeAppQRCode(t,n){return g(this,null,function*(){var i,o;try{let a=`${S}${C}/${t}?notificationURL=${this.options.notificationURL}&latitude=${(i=this.location)==null?void 0:i.latitude}&longitude=${(o=this.location)==null?void 0:o.longitude}`,r=yield I(a,{[x]:this.apiKey,[N]:n});this.displayQRCode(r.qrCodeUrl,r.deepLink),this.startPolling(r.sessionId),R("QR code generated successfully")}catch(a){this.qrContainer&&(this.qrContainer.innerHTML=m()),p("Failed to generate Age App QR code:",a)}})}};var c=(()=>{let e=null,t,n="",i="";function o(r){e=document.querySelector(r.qrCodeSelector),e&&(t=r.generateQRCodeFunction,n=r.successRedirectURL||"",i=r.failRedirectURL||"")}function a(r){var l;if(!e)return;let d=w(r);e.innerHTML=`<div class='w-100 h-100 align-content-center'>${d}</div>`,r===s.Timeout&&t&&((l=document.getElementById("new-qr-button"))==null||l.addEventListener("click",t)),r===s.Approved&&n&&f(n,u),(r===s.RejectedByUser||r===s.RejectedByRequirement)&&i&&f(i,u),r===s.SomethingWentWrong&&i&&f(i,u)}return{setOptions:o,handleState:a,STATES:s}})();(()=>{let{apiKey:e,successRedirectURL:t,failRedirectURL:n,notificationURL:i}=W();if(R({apiKey:e,successRedirectURL:t,failRedirectURL:n,notificationURL:i}),!e)return p("Missing 'apiKey' in script tag. Example usage: <script src='...main.js data-api-key=your-api-key'>");let o=new T(e);o.configure({qrContainerSelector:A,logContainerSelector:H,successRedirectURL:t,failRedirectURL:n,notificationURL:i,onVerificationWaitingForScan:()=>c.handleState(c.STATES.WaitingForScan),onVerificationSuccess:()=>c.handleState(c.STATES.Approved),onVerificationFailure:()=>c.handleState(c.STATES.Timeout),onVerificationScanning:()=>c.handleState(c.STATES.Scanned),onVerificationRejectedByUser:()=>c.handleState(c.STATES.RejectedByUser),onVerificationRejectedByRequirements:()=>c.handleState(c.STATES.RejectedByRequirement),onVerificationTimeout:()=>c.handleState(c.STATES.Timeout)}),c.setOptions({qrCodeSelector:A,generateQRCodeFunction:()=>o.validateIdentityAndGenerateQRCode(),successRedirectURL:t,failRedirectURL:n}),window.bitIdentityVerification=o,o.validateIdentityAndGenerateQRCode()})();})();
