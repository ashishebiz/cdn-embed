"use strict";var IdentityVerificationCDN=(()=>{var G=Object.defineProperty;var L=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable;var v=(e,t,n)=>t in e?G(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,u=(e,t)=>{for(var n in t||(t={}))H.call(t,n)&&v(e,n,t[n]);if(L)for(var n of L(t))Q.call(t,n)&&v(e,n,t[n]);return e};var d=(e,t,n)=>new Promise((i,o)=>{var r=c=>{try{l(n.next(c))}catch(R){o(R)}},g=c=>{try{l(n.throw(c))}catch(R){o(R)}},l=c=>c.done?i(c.value):Promise.resolve(c.value).then(r,g);l((n=n.apply(e,t)).next())});var f="http://localhost:8888",T="/rule-engine/v1/age-app-embed/generate-qr",S="/rule-engine/v1/age-app-embed/get-qr",A="/public-base/v1/embed/validate",E="x-sign-key",_="x-organization-id",w={"Content-Type":"application/json"},N={AGE_APP:"age_app",CHECK_IN:"check_in"},C="#embed-qr-code",b="#embed-qr-code-logs",D=5e3,h=1e4,s={WaitingForScan:"WaitingForScan",Timeout:"Timeout",Scanned:"Scanned",Approved:"Approved",RejectedByUser:"RejectedByUser",RejectedByRequirement:"RejectedByRequirement",SomethingWentWrong:"SomethingWentWrong"};function y(n){return d(this,arguments,function*(e,t={}){var o;let i=yield fetch(e,{method:"GET",headers:t});if(!i.ok){let r=(o=yield i.json())==null?void 0:o.message;throw alert(r),new Error(`${i.status} : ${r}`)}return i.json()})}function P(i,o){return d(this,arguments,function*(e,t,n={}){var g;let r=yield fetch(e,{method:"POST",headers:u(u({},w),n),body:JSON.stringify(t)});if(!r.ok){let l=(g=yield r.json())==null?void 0:g.message;throw alert(l),new Error(`${r.status} : ${l}`)}return r.json()})}var U=e=>({Timeout:`
    <div style="margin-bottom: 10px; color: #fff;">QR expired.</div>
    <a id='new-qr-button' style="
      margin-top: 10px;
      display: inline-block;
      padding: 10px 20px;
      background-color: #000;
      border: 1px solid #fff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      cursor:pointer;
    ">New QR</a>
  `,Scanned:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u23F3</div>
    <div style="color: #fff;">Scanning in progress...</div>
  `,Approved:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u2705</div>
    <div style="color: #00ff99;">Access granted in 10s.</div>
  `,RejectedByUser:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u274C</div>
    <div style="color: #ff4444;">Access Denied</div>
  `,RejectedByRequirement:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u274C</div>
    <div style="color: #ff4444;">Access Denied</div>
  `,WaitingForScan:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u{1F4F7}</div>
    <div style="color: #fff;">Waiting for scan...</div>
  `,SomethingWentWrong:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u26A0\uFE0F</div>
    <div style="color: #ff4444;">Something went wrong</div>
  `})[e],O=e=>({Timeout:"QR Expired",Scanned:"Scanning in progress",Approved:"Access Granted",RejectedByUser:"Access Denied",RejectedByRequirement:"Access Denied",WaitingForScan:"Waiting for scan",SomethingWentWrong:"Something went wrong"})[e];var x=e=>document.querySelector(e);function q(e,t){if(!e)return;let n=document.createElement("p");n.innerHTML=O(t),n.style.cssText="margin-bottom:10px;padding:8px;",e.prepend(n)}var p=(...e)=>console.log("[cdn-embed]",...e),a=(...e)=>console.error("[cdn-embed]",...e);var I=(e,t)=>{setTimeout(()=>{window.location.href=e},t)},k=()=>{let e=document.currentScript;return{apiKey:(e==null?void 0:e.dataset.apiKey)||"",successRedirectURL:(e==null?void 0:e.dataset.successUrl)||"",failRedirectURL:(e==null?void 0:e.dataset.failureUrl)||"",notificationURL:(e==null?void 0:e.dataset.notificationUrl)||""}};var m=class{constructor(){this.pollingId=null;this.qrContainer=null}configure(t){this.options=t}displayQRCode(t,n){var i;if(this.qrContainer=x(this.options.qrContainerSelector),!this.qrContainer){a("QR Container not found"),this.pollingId&&clearInterval(this.pollingId);return}this.qrContainer.innerHTML=`<div id="qr-code" class="w-100 h-100" style="cursor:pointer;text-align:center;">
      <img src="${t}" alt="QR Code" style="width:100%;height:100%;" /></div>`,(i=document.getElementById("qr-code"))==null||i.addEventListener("click",()=>window.open(n,"_blank"))}startPolling(t){if(this.pollingId&&clearInterval(this.pollingId),!t)throw new Error("Session ID not found");this.pollingId=window.setInterval(()=>d(this,null,function*(){try{let n=`${f}${S}/${t}`,i=yield y(n,{[E]:this.options.apiKey});q(x(this.options.logContainerSelector||""),i.scanningState),i!=null&&i.scanningState&&this.handleState(i.scanningState)}catch(n){a("Polling error",n),this.handleState(s.Timeout),this.pollingId&&clearInterval(this.pollingId)}}),D)}handleState(t){var o;let n=this.options;n.qrContainerSelector||(a("QR Container not found"),this.pollingId&&clearInterval(this.pollingId));let i=U(t);switch(this.qrContainer&&t!==s.WaitingForScan&&(this.qrContainer.innerHTML=`<div  style="
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        flex-direction: column;
        ">${i}</div>`),t){case s.WaitingForScan:case s.Scanned:break;case s.Approved:n.successRedirectURL&&I(n.successRedirectURL,h);break;case s.Timeout:p(this.options),(o=document.getElementById("new-qr-button"))==null||o.addEventListener("click",()=>this.validateIdentityAndGenerateQRCode()),this.pollingId&&clearInterval(this.pollingId);break;case s.SomethingWentWrong:n.failRedirectURL&&I(n.failRedirectURL,h),this.pollingId&&clearInterval(this.pollingId);case s.RejectedByUser:case s.RejectedByRequirement:default:a("Invalid state:",t),this.pollingId&&clearInterval(this.pollingId);break}}validateIdentityAndGenerateQRCode(){return d(this,null,function*(){try{let t=`${f}${A}`,n=yield P(t,{token:this.options.apiKey,successNavigateUrl:this.options.successRedirectURL,failureNavigateUrl:this.options.failRedirectURL,notificationUrl:this.options.notificationURL});if(!n.status||!n.data)throw new Error("Invalid identity");let{contextType:i,entityId:o,orgId:r}=n.data;switch(i){case N.AGE_APP:yield this.generateAgeAppQRCode(o,r),p("QR code generated successfully");break;default:a("Unknown context type");break}return}catch(t){a("Failed to generate QR code:",t)}})}generateAgeAppQRCode(t,n){return d(this,null,function*(){try{let i=`${f}${T}/${t}?notificationURL=${this.options.notificationURL}`,o=yield y(i,{[E]:this.options.apiKey,[_]:n});this.displayQRCode(o.qrCodeUrl,o.deepLink),this.startPolling(o.sessionId)}catch(i){a("Failed to generate Age App QR code:",i)}})}};(()=>{let{apiKey:e,successRedirectURL:t,failRedirectURL:n,notificationURL:i}=k();if(p({apiKey:e,successRedirectURL:t,failRedirectURL:n,notificationURL:i}),!e)return a("Missing 'apiKey' in script tag. Example usage: <script src='...main.js data-api-key=your-api-key'>");let o=new m;o.configure({apiKey:e,qrContainerSelector:C,logContainerSelector:b,successRedirectURL:t,failRedirectURL:n,notificationURL:i}),o.validateIdentityAndGenerateQRCode()})();})();
