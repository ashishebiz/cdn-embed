"use strict";var IdentityVerificationCDN=(()=>{var V=Object.defineProperty;var A=Object.getOwnPropertySymbols;var j=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var w=(e,t,o)=>t in e?V(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,L=(e,t)=>{for(var o in t||(t={}))j.call(t,o)&&w(e,o,t[o]);if(A)for(var o of A(t))B.call(t,o)&&w(e,o,t[o]);return e};var s=(e,t,o)=>new Promise((n,i)=>{var r=c=>{try{p(o.next(c))}catch(E){i(E)}},a=c=>{try{p(o.throw(c))}catch(E){i(E)}},p=c=>c.done?n(c.value):Promise.resolve(c.value).then(r,a);p((o=o.apply(e,t)).next())});var f="https://api.chainit.online",I="/rule-engine/v1/age-app-embed/generate-qr",_="/rule-engine/v1/age-app-embed/get-qr",P="/public-base/v1/embed/validate",x="x-sign-key",b="x-organization-id",C={"Content-Type":"application/json"},N={AGE_APP:"age_app",CHECK_IN:"check_in"},M="#embed-qr-code",H="#embed-qr-code-logs",G=5e3,y=1e4,l={WaitingForScan:"WaitingForScan",Timeout:"Timeout",Scanned:"Scanned",Approved:"Approved",RejectedByUser:"RejectedByUser",RejectedByRequirement:"RejectedByRequirement",SomethingWentWrong:"SomethingWentWrong"},u="Location permission denied. Please enable it manually in browser settings.",T="Geolocation is not supported by this browser";function S(o){return s(this,arguments,function*(e,t={}){var i;let n=yield fetch(e,{method:"GET",headers:t});if(!n.ok){let r=(i=yield n.json())==null?void 0:i.message;throw alert(r),new Error(`${n.status} : ${r}`)}return n.json()})}function q(n,i){return s(this,arguments,function*(e,t,o={}){var a;let r=yield fetch(e,{method:"POST",headers:L(L({},C),o),body:JSON.stringify(t)});if(!r.ok){let p=(a=yield r.json())==null?void 0:a.message;throw alert(p),new Error(`${r.status} : ${p}`)}return r.json()})}var F=e=>({Timeout:`
    <div style="margin-bottom: 10px; color: #fff;">QR expired.</div>
    <a id='new-qr-button' style="
      margin-top: 10px;
      display: inline-block;
      padding: 10px 20px;
      background-color: #000;
      border: 1px solid #fff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      cursor:pointer;
    ">New QR</a>
  `,Scanned:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u23F3</div>
    <div style="color: #fff;">Scanning in progress...</div>
  `,Approved:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u2705</div>
    <div style="color: #00ff99;">Access granted in 10s.</div>
  `,RejectedByUser:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u274C</div>
    <div style="color: #ff4444;">Access Denied</div>
  `,RejectedByRequirement:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u274C</div>
    <div style="color: #ff4444;">Access Denied</div>
  `,WaitingForScan:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u{1F4F7}</div>
    <div style="color: #fff;">Waiting for scan...</div>
  `,SomethingWentWrong:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u26A0\uFE0F</div>
    <div style="color: #ff4444;">Something went wrong</div>
  `})[e],D=e=>({Timeout:"QR Expired",Scanned:"Scanning in progress",Approved:"Access Granted",RejectedByUser:"Access Denied",RejectedByRequirement:"Access Denied",WaitingForScan:"Waiting for scan",SomethingWentWrong:"Something went wrong"})[e],g=(e="Something went wrong")=>`<div style="background:#111;color:#fff;padding:10px 14px;border-radius:6px;font-size:14px;">${e}</div>`;function U(e){return`
    <div id="qr-code" class="w-100 h-100" style="cursor:pointer;text-align:center;">
      <img src="${e}" alt="QR Code" style="width:100%;height:100%;" />
    </div>
    `}function O(e){return`
    <div style="
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      flex-direction: column;">
      ${F(e)}
    </div>
  `}var R=e=>document.querySelector(e);function k(e,t){if(!e)return;let o=document.createElement("p");o.innerHTML=D(t),o.style.cssText="margin-bottom:10px;padding:8px;",e.prepend(o)}var v=(e,t)=>setTimeout(()=>window.location.href=e,t);var m=(...e)=>console.log("[cdn-embed]",...e),d=(...e)=>console.error("[cdn-embed]",...e);var Q=e=>{let t=e*1e3;return new Promise(o=>setTimeout(o,t))},W=()=>{let e=document.currentScript;return{apiKey:(e==null?void 0:e.dataset.apiKey)||"",successRedirectURL:(e==null?void 0:e.dataset.successUrl)||"",failRedirectURL:(e==null?void 0:e.dataset.failureUrl)||"",notificationURL:(e==null?void 0:e.dataset.notificationUrl)||""}},$=e=>s(null,null,function*(){if((yield K())==="denied")throw e&&(e.innerHTML=g(u)),new Error(u);return new Promise((o,n)=>{"geolocation"in navigator?navigator.geolocation.getCurrentPosition(i=>{var p,c;let r=(p=i.coords.latitude)!=null?p:0,a=(c=i.coords.longitude)!=null?c:0;o({latitude:r,longitude:a})},i=>{e&&(e.innerHTML=g(u)),n(`ERR_LOC : Error getting location: ${i.message}`)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):(e&&(e.innerHTML=g(T)),n(T))})}),K=()=>s(null,null,function*(){if(!navigator.permissions)return"prompt";try{return(yield navigator.permissions.query({name:"geolocation"})).state}catch(e){return"prompt"}});var h=class{constructor(){this.pollingId=null;this.qrContainer=null;this.location=null}configure(t){this.options=t}clearPolling(){this.pollingId!==null&&(clearInterval(this.pollingId),this.pollingId=null)}displayQRCode(t,o){var n;if(this.qrContainer=R(this.options.qrContainerSelector),!this.qrContainer){d("QR Container not found"),this.clearPolling();return}this.qrContainer.innerHTML=U(t),(n=document.getElementById("qr-code"))==null||n.addEventListener("click",()=>window.open(o,"_blank"))}startPolling(t){if(this.clearPolling(),!t)throw new Error("Session ID not found");this.pollingId=window.setInterval(()=>s(this,null,function*(){try{let o=`${f}${_}/${t}`,n=yield S(o,{[x]:this.options.apiKey});k(R(this.options.logContainerSelector||""),n.scanningState),n!=null&&n.scanningState&&(yield this.handleState(n.scanningState))}catch(o){this.qrContainer&&(this.qrContainer.innerHTML=g()),d("Polling error",o),yield this.handleState(l.Timeout),this.clearPolling()}}),G)}handleState(t){return s(this,null,function*(){var n;let o=this.options;if(!o.qrContainerSelector){d("QR Container selector not provided"),this.clearPolling();return}switch(this.qrContainer&&t!==l.WaitingForScan&&(this.qrContainer.innerHTML=O(t)),t){case l.WaitingForScan:case l.Scanned:m(t);break;case l.Approved:this.clearPolling(),o.successRedirectURL&&v(o.successRedirectURL,y);break;case l.Timeout:m(o),this.clearPolling(),(n=document.getElementById("new-qr-button"))==null||n.addEventListener("click",()=>this.validateIdentityAndGenerateQRCode());break;case l.SomethingWentWrong:this.clearPolling(),o.failRedirectURL&&v(o.failRedirectURL,y);break;case l.RejectedByUser:case l.RejectedByRequirement:this.clearPolling(),yield Q(10),yield this.validateIdentityAndGenerateQRCode();break;default:d("Invalid state:",t),this.clearPolling();break}})}validateIdentityAndGenerateQRCode(){return s(this,null,function*(){try{this.qrContainer=R(this.options.qrContainerSelector),this.location=yield $(this.qrContainer);let t=`${f}${P}`,o=yield q(t,{token:this.options.apiKey,successNavigateUrl:this.options.successRedirectURL,failureNavigateUrl:this.options.failRedirectURL,notificationUrl:this.options.notificationURL});if(!o.status||!o.data)throw new Error("Invalid identity");let{contextType:n,entityId:i,orgId:r}=o.data;switch(n){case N.AGE_APP:yield this.generateAgeAppQRCode(i,r);break;default:d("Unknown context type");break}return}catch(t){this.qrContainer&&(this.qrContainer.innerHTML=g()),d("Failed to generate QR code:",t)}})}generateAgeAppQRCode(t,o){return s(this,null,function*(){var n,i;try{let r=`${f}${I}/${t}?notificationURL=${this.options.notificationURL}&latitude=${(n=this.location)==null?void 0:n.latitude}&longitude=${(i=this.location)==null?void 0:i.longitude}`,a=yield S(r,{[x]:this.options.apiKey,[b]:o});this.displayQRCode(a.qrCodeUrl,a.deepLink),this.startPolling(a.sessionId),m("QR code generated successfully")}catch(r){this.qrContainer&&(this.qrContainer.innerHTML=g()),d("Failed to generate Age App QR code:",r)}})}};(()=>{let{apiKey:e,successRedirectURL:t,failRedirectURL:o,notificationURL:n}=W();if(m({apiKey:e,successRedirectURL:t,failRedirectURL:o,notificationURL:n}),!e)return d("Missing 'apiKey' in script tag. Example usage: <script src='...main.js data-api-key=your-api-key'>");let i=new h;i.configure({apiKey:e,qrContainerSelector:M,logContainerSelector:H,successRedirectURL:t,failRedirectURL:o,notificationURL:n}),i.validateIdentityAndGenerateQRCode()})();})();
