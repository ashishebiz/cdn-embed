"use strict";var IdentityVerificationCDN=(()=>{var j=Object.defineProperty;var I=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var _=(e,n,t)=>n in e?j(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,L=(e,n)=>{for(var t in n||(n={}))B.call(n,t)&&_(e,t,n[t]);if(I)for(var t of I(n))$.call(n,t)&&_(e,t,n[t]);return e};var g=(e,n,t)=>new Promise((o,i)=>{var s=l=>{try{d(t.next(l))}catch(y){i(y)}},r=l=>{try{d(t.throw(l))}catch(y){i(y)}},d=l=>l.done?o(l.value):Promise.resolve(l.value).then(s,r);d((t=t.apply(e,n)).next())});var f="http://localhost:8888",P="/rule-engine/v1/age-app-embed/generate-qr",M="/rule-engine/v1/age-app-embed/get-qr",C="/public-api/v1/embed/validate",x="x-sign-key",b="x-organization-id",N={"Content-Type":"application/json"},H={AGE_APP:"age_app",CHECK_IN:"check_in"},A="#embed-qr-code",U="#embed-qr-code-logs",q=5e3,R=1e4,a={WaitingForScan:"WaitingForScan",Timeout:"Timeout",Scanned:"Scanned",Approved:"Approved",RejectedByUser:"RejectedByUser",RejectedByRequirement:"RejectedByRequirement",SomethingWentWrong:"SomethingWentWrong"},u="Location permission denied. Please enable it manually in browser settings.",v="Geolocation is not supported by this browser";var D=e=>({Timeout:`
    <div style="margin-bottom: 10px; color: #fff;">QR expired.</div>
    <a id='new-qr-button' style="
      margin-top: 10px;
      display: inline-block;
      padding: 10px 20px;
      background-color: #000;
      border: 1px solid #fff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      cursor:pointer;
    ">New QR</a>
  `,Scanned:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u23F3</div>
    <div style="color: #fff;">Scanning in progress...</div>
  `,Approved:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u2705</div>
    <div style="color: #00ff99;">Access granted in 10s.</div>
  `,RejectedByUser:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u274C</div>
    <div style="color: #ff4444;">Access Denied</div>
  `,RejectedByRequirement:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u274C</div>
    <div style="color: #ff4444;">Access Denied</div>
  `,WaitingForScan:"",SomethingWentWrong:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u26A0\uFE0F</div>
    <div style="color: #ff4444;">Something went wrong</div>
  `})[e],O=e=>({Timeout:"QR Expired",Scanned:"Scanning in progress",Approved:"Access Granted",RejectedByUser:"Access Denied",RejectedByRequirement:"Access Denied",WaitingForScan:"Waiting for scan",SomethingWentWrong:"Something went wrong"})[e],m=(e="Something went wrong")=>`<div style="background:#111;color:#fff;padding:10px 14px;border-radius:6px;font-size:14px;">${e}</div>`;function V(e){return`
    <div id="qr-code" class="w-100 h-100" style="cursor:pointer;text-align:center;">
      <img src="${e}" alt="QR Code" style="width:100%;height:100%;" />
    </div>
    `}var S=e=>document.querySelector(e);function G(e,n){if(!e)return;let t=document.createElement("p");t.innerHTML=O(n),t.style.cssText="margin-bottom:10px;padding:8px;",e.prepend(t)}var h=(e,n)=>setTimeout(()=>window.location.href=e,n);var E=(...e)=>console.log("[cdn-embed]",...e),p=(...e)=>console.error("[cdn-embed]",...e);var W=()=>{let e=document.currentScript;return console.log("\u{1F680} ~ script 001",e),{apiKey:(e==null?void 0:e.dataset.apiKey)||"",successRedirectURL:(e==null?void 0:e.dataset.successUrl)||"",failRedirectURL:(e==null?void 0:e.dataset.failureUrl)||"",notificationURL:(e==null?void 0:e.dataset.notificationUrl)||""}},Q=e=>g(null,null,function*(){if((yield F())==="denied")throw e&&(e.innerHTML=m(u)),alert(u),new Error(u);return new Promise((t,o)=>{"geolocation"in navigator?navigator.geolocation.getCurrentPosition(i=>{var d,l;let s=(d=i.coords.latitude)!=null?d:0,r=(l=i.coords.longitude)!=null?l:0;t({latitude:s,longitude:r})},i=>{e&&(e.innerHTML=m(u)),o(`ERR_LOC : Error getting location: ${i.message}`)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):(e&&(e.innerHTML=m(v)),o(v))})}),F=()=>g(null,null,function*(){if(!navigator.permissions)return"prompt";try{return(yield navigator.permissions.query({name:"geolocation"})).state}catch(e){return"prompt"}});function w(t){return g(this,arguments,function*(e,n={}){var i;let o=yield fetch(e,{method:"GET",headers:n});if(!o.ok){let s=(i=yield o.json())==null?void 0:i.message;throw alert("Something Went Wrong"),new Error(`${o.status} : ${s}`)}return o.json()})}function k(o,i){return g(this,arguments,function*(e,n,t={}){var r;let s=yield fetch(e,{method:"POST",headers:L(L({},N),t),body:JSON.stringify(n)});if(!s.ok){let d=(r=yield s.json())==null?void 0:r.message;throw alert("Something Went Wrong"),new Error(`${s.status} : ${d}`)}return s.json()})}var T=class{constructor(n){this.pollingId=null;this.qrContainer=null;this.location=null;this.apiKey="";this.apiKey=n}configure(n){this.options=n}clearPolling(){this.pollingId!==null&&(clearInterval(this.pollingId),this.pollingId=null)}displayQRCode(n,t){var o;if(this.qrContainer=S(this.options.qrContainerSelector),!this.qrContainer){p("QR Container not found"),this.clearPolling();return}this.qrContainer.innerHTML=V(n),(o=document.getElementById("qr-code"))==null||o.addEventListener("click",()=>window.open(t,"_blank"))}startPolling(n){if(this.clearPolling(),!n)throw new Error("Session ID not found");this.pollingId=window.setInterval(()=>g(this,null,function*(){try{let t=`${f}${M}/${n}`,o=yield w(t,{[x]:this.apiKey});G(S(this.options.logContainerSelector||""),o.scanningState),o!=null&&o.scanningState&&(yield this.handleState(o.scanningState))}catch(t){this.qrContainer&&(this.qrContainer.innerHTML=m()),p("Polling error",t),yield this.handleState(a.Timeout),this.clearPolling()}}),q)}handleState(n){return g(this,null,function*(){let t=this.options;if(!t.qrContainerSelector){p("QR Container selector not provided"),this.clearPolling();return}switch(n){case a.WaitingForScan:return;case a.Scanned:return t.onVerificationScanning();case a.Approved:return this.clearPolling(),t.onVerificationSuccess();case a.RejectedByUser:return this.clearPolling(),t.onVerificationRejectedByUser();case a.RejectedByRequirement:return this.clearPolling(),t.onVerificationRejectedByRequirements();case a.Timeout:return this.clearPolling(),t.onVerificationTimeout();case a.SomethingWentWrong:return this.clearPolling(),t.onVerificationFailure()}})}validateIdentityAndGenerateQRCode(){return g(this,null,function*(){try{this.qrContainer=S(this.options.qrContainerSelector),this.location=yield Q(this.qrContainer);let n=`${f}${C}`,t=yield k(n,{token:this.apiKey,successNavigateUrl:this.options.successRedirectURL,failureNavigateUrl:this.options.failRedirectURL,notificationUrl:this.options.notificationURL});if(!t.status||!t.data)throw new Error("Invalid identity");let{contextType:o,entityId:i,orgId:s}=t.data;switch(o){case H.AGE_APP:yield this.generateAgeAppQRCode(i,s);break;default:p("Unknown context type");break}return}catch(n){p("Failed to generate QR code:",n)}})}generateAgeAppQRCode(n,t){return g(this,null,function*(){var o,i;try{let s=`${f}${P}/${n}?notificationURL=${this.options.notificationURL}&latitude=${(o=this.location)==null?void 0:o.latitude}&longitude=${(i=this.location)==null?void 0:i.longitude}`,r=yield w(s,{[x]:this.apiKey,[b]:t});this.displayQRCode(r.qrCodeUrl,r.deepLink),this.startPolling(r.sessionId),E("QR code generated successfully")}catch(s){this.qrContainer&&(this.qrContainer.innerHTML=m()),p("Failed to generate Age App QR code:",s)}})}};var c=(()=>{let e=null,n,t="",o="";function i(r){e=document.querySelector(r.qrCodeSelector),e&&(n=r.generateQRCodeFunction,t=r.successRedirectURL||"",o=r.failRedirectURL||"")}function s(r){var l;if(!e)return;let d=D(r);e.innerHTML=`<div class='w-100 h-100 align-content-center'>${d}</div>`,r===a.Timeout&&n&&((l=document.getElementById("new-qr-button"))==null||l.addEventListener("click",n)),r===a.Approved&&t&&h(t,R),(r===a.RejectedByUser||r===a.RejectedByRequirement)&&o&&h(o,R),r===a.SomethingWentWrong&&o&&h(o,R)}return{setOptions:i,handleState:s,STATES:a}})();(()=>{let{apiKey:e,successRedirectURL:n,failRedirectURL:t,notificationURL:o}=W();if(E({apiKey:e,successRedirectURL:n,failRedirectURL:t,notificationURL:o}),!e)return p("Missing 'apiKey' in script tag. Example usage: <script src='...main.js data-api-key=your-api-key'>");let i=new T(e);i.configure({qrContainerSelector:A,logContainerSelector:U,successRedirectURL:n,failRedirectURL:t,notificationURL:o,onVerificationWaitingForScan:()=>c.handleState(c.STATES.WaitingForScan),onVerificationSuccess:()=>c.handleState(c.STATES.Approved),onVerificationFailure:()=>c.handleState(c.STATES.SomethingWentWrong),onVerificationScanning:()=>c.handleState(c.STATES.Scanned),onVerificationRejectedByUser:()=>c.handleState(c.STATES.RejectedByUser),onVerificationRejectedByRequirements:()=>c.handleState(c.STATES.RejectedByRequirement),onVerificationTimeout:()=>c.handleState(c.STATES.Timeout)}),c.setOptions({qrCodeSelector:A,generateQRCodeFunction:()=>i.validateIdentityAndGenerateQRCode(),successRedirectURL:n,failRedirectURL:t}),window.bitIdentityVerification=i,i.validateIdentityAndGenerateQRCode()})();})();
